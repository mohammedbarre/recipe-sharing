<h1>Search Recipes</h1>

<!-- Search Form -->
<form action="/api/search-recipes" method="GET" id="search-form">
    <input type="text" name="q" placeholder="Enter a recipe name or ingredient" required>
    <button type="submit">Search</button>
</form>

<!-- Results Section -->
<div id="results">
    <h2>Search Results</h2>
    <ul id="recipe-list"></ul>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('search-form');
        const recipeList = document.getElementById('recipe-list');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = form.querySelector('input[name="q"]').value;

            try {
                const response = await fetch(`/api/search-recipes?q=${query}`);
                const data = await response.json();

                recipeList.innerHTML = '';

                if (data.results && data.results.length > 0) {
                    data.results.forEach(recipe => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <h3>${recipe.name}</h3>
                            <img src="${recipe.thumbnail_url}" alt="${recipe.name}" style="width: 200px;">
                            <button class="view-details" data-id="${recipe.id}">View Details</button>
                            <button class="save-recipe" data-id="${recipe.id}" data-name="${recipe.name}">Save Recipe</button>
                            <div class="details-container" id="details-${recipe.id}" style="display: none;"></div>
                        `;
                        recipeList.appendChild(listItem);
                    });

                    document.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const recipeId = button.dataset.id;
                            const detailsContainer = document.getElementById(`details-${recipeId}`);

                            if (detailsContainer.style.display === 'block') {
                                detailsContainer.style.display = 'none';
                                return;
                            }

                            try {
                                const detailsResponse = await fetch(`/api/recipe-details/${recipeId}`);
                                const detailsData = await detailsResponse.json();

                                detailsContainer.innerHTML = `
                                    <h4>Ingredients:</h4>
                                    <ul>${detailsData.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>
                                    <h4>Instructions:</h4>
                                    <ol>${detailsData.steps.map(step => `<li>${step}</li>`).join('')}</ol>
                                `;
                                detailsContainer.style.display = 'block';
                            } catch (error) {
                                console.error('Error fetching recipe details:', error);
                                detailsContainer.innerHTML = '<p>Failed to load details.</p>';
                            }
                        });
                    });

                    document.querySelectorAll('.save-recipe').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const recipeId = button.dataset.id;
                            const recipeName = button.dataset.name;

                            try {
                                const response = await fetch('/save-recipe', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ recipeId, recipeName })
                                });

                                const result = await response.json();
                                if (result.success) {
                                    alert('Recipe saved successfully!');
                                } else {
                                    alert('Failed to save recipe.');
                                }
                            } catch (error) {
                                console.error('Error saving recipe:', error);
                                alert('An error occurred while saving the recipe. Please try again.');
                            }
                        });
                    });
                } else {
                    recipeList.innerHTML = '<p>No recipes found. Try a different search term.</p>';
                }
            } catch (error) {
                console.error('Error fetching recipes:', error);
                recipeList.innerHTML = '<p>Failed to load recipes. Please try again.</p>';
            }
        });
    });
</script>
